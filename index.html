<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>千与千寻 - 台词分析系统</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* 头部样式 */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            position: relative;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            flex-wrap: wrap;
        }
        
        h1 {
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
            color: white;
            margin: 0;
            padding: 10px 20px;
        }
        
        .header-buttons {
            display: flex;
            gap: 15px;
            padding: 10px;
        }
        
        /* 控制区域样式 */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .file-upload-btn, .edit-columns-btn, .playlist-btn, .row-edit-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-upload-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }
        
        .edit-columns-btn {
            background: linear-gradient(to right, #ff9966, #ff5e62);
            color: white;
        }
        
        .playlist-btn {
            background: linear-gradient(to right, #8A2BE2, #4B0082);
            color: white;
        }
        
        .row-edit-btn {
            background: linear-gradient(to right, #FF8C00, #FF4500);
            color: white;
        }
        
        .file-upload-btn:hover, .edit-columns-btn:hover, .playlist-btn:hover, .row-edit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .file-input {
            display: none;
        }
        
        /* 缓存指示器 */
        .cache-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 2000;
            animation: fadeIn 0.5s;
        }
        
        .cache-indicator .cache-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #4CAF50;
        }
        
        /* 列编辑面板 */
        .column-editor {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .column-editor h3 {
            margin-bottom: 15px;
            color: #444;
            text-align: center;
        }
        
        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .column-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 表格样式 */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 800px;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
            position: relative;
        }
        
        th {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th:hover {
            background: linear-gradient(to bottom, #e9ecef, #dee2e6);
        }
        
        /* 音频单元格样式 */
        .audio-cell {
            cursor: pointer;
            position: relative;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .audio-cell .audio-placeholder {
            color: #666;
            font-style: italic;
            padding: 8px 12px;
            border-radius: 20px;
            background-color: #f0f5ff;
            transition: all 0.3s;
        }
        
        .audio-cell .audio-placeholder:hover {
            background-color: #e0ebff;
        }
        
        .audio-cell .audio-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: #4CAF50;
            border-radius: 50%;
            position: relative;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .audio-cell .audio-icon::before {
            content: '';
            position: absolute;
            top: 7px;
            left: 9px;
            width: 0;
            height: 0;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 8px solid white;
        }
        
        .audio-cell .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            background-color: #f0f5ff;
            border-radius: 20px;
            transition: all 0.3s;
        }
        
        .audio-cell .audio-controls:hover {
            background-color: #e0ebff;
        }
        
        .audio-cell .add-audio-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        .audio-cell .add-audio-btn:hover {
            background-color: #3d8b40;
        }
        
        /* 卡片样式 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: scale(0.95);
            animation: cardAppear 0.4s forwards;
        }
        
        @keyframes cardAppear {
            to {
                transform: scale(1);
            }
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 24px;
            color: #333;
        }
        
        .card-content {
            line-height: 1.8;
        }
        
        .card-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }
        
        .card-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .card-label {
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .card-value {
            font-size: 18px;
            color: #333;
            line-height: 1.6;
        }
        
        .analysis-section {
            margin-top: 25px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .analysis-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analysis-section h3 svg {
            width: 20px;
            height: 20px;
        }
        
        .analysis-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }
        
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .analysis-table th {
            background-color: #e9ecef;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .analysis-table td {
            padding: 10px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .analysis-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .analysis-buttons {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .analysis-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lexical-btn {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
        }
        
        .syntactic-btn {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
        }
        
        .add-audio-btn-card {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
            margin-top: 10px;
        }
        
        .analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        
        /* 列宽调整手柄 */
        .resizer {
            position: absolute;
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            background: #ccc;
            cursor: col-resize;
            user-select: none;
            z-index: 1;
        }
        
        .resizer:hover, .resizing {
            background: #4a8cff;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        /* 卡片优化样式 */
        .card-sentences {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #eef2f7 100%);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .english-sentence {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .chinese-sentence {
            font-size: 1.1rem;
            color: #495057;
            line-height: 1.6;
            font-style: italic;
        }
        
        .audio-section {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .card-header .analysis-buttons {
            margin-top: 0;
        }
        
        .card-header .analysis-btn {
            padding: 8px 15px;
            font-size: 13px;
        }
        
        .card-header .analysis-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* 英文台词提示框 */
        .english-tooltip {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 400px;
            font-size: 16px;
            line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .english-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 语法分析提示框 */
        .syntax-tooltip {
            position: fixed;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1001;
            max-width: 500px;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .syntax-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .syntax-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .syntax-header svg {
            width: 18px;
            height: 18px;
        }
        
        .syntax-content {
            padding: 5px 0;
        }
        
        .syntax-item {
            margin-bottom: 8px;
            display: flex;
        }
        
        .syntax-label {
            min-width: 120px;
            font-weight: 600;
            color: #3498db;
        }
        
        .syntax-value {
            flex: 1;
        }
        
        /* 行编辑面板 */
        .row-editor {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .row-editor h3 {
            margin-bottom: 15px;
            color: #444;
            text-align: center;
        }
        
        .row-editor-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* 播放列表卡片 */
        .playlist-card {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: scale(0.95);
            animation: cardAppear 0.4s forwards;
        }
        
        .playlist-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .playlist-table th {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
        }
        
        .playlist-table td {
            padding: 12px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .playlist-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .playlist-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .playlist-btn-action {
            padding: 10px 25px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .play-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }
        
        .stop-btn {
            background: linear-gradient(to right, #ff9966, #ff5e62);
            color: white;
        }
        
        .playlist-btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .playlist-audio-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 50%;
            position: relative;
            margin-right: 8px;
        }
        
        .playlist-audio-icon::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 7px;
            width: 0;
            height: 0;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 8px solid white;
        }
        
        /* 当前播放指示器 */
        .playing-row {
            background-color: #e0f7fa !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { background-color: #e0f7fa; }
            50% { background-color: #b2ebf2; }
            100% { background-color: #e0f7fa; }
        }
        
        /* 行选择列样式 - 修复 */
        .row-selector-header {
            width: 40px;
        }
        
        .row-selector-cell {
            width: 40px;
            text-align: center;
        }
        
        .row-selector {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* 默认隐藏行选择列 */
        .row-selector-header, .row-selector-cell {
            display: none;
        }
        
        /* 行编辑打开时显示行选择列 */
        .row-editor-visible .row-selector-header,
        .row-editor-visible .row-selector-cell {
            display: table-cell;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            h1 {
                font-size: 2.5rem;
                width: 100%;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .file-upload-btn, .edit-columns-btn, .playlist-btn, .row-edit-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
            
            .analysis-buttons {
                flex-direction: column;
            }
            
            .card {
                width: 95%;
                padding: 20px;
            }
            
            .cache-indicator {
                top: 5px;
                right: 5px;
                font-size: 12px;
                padding: 5px 10px;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .card-header .analysis-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .english-tooltip {
                max-width: 300px;
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .syntax-tooltip {
                max-width: 300px;
                font-size: 13px;
                padding: 10px;
            }
            
            .syntax-label {
                min-width: 100px;
            }
            
            .row-editor-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .playlist-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="cache-indicator" id="cacheIndicator" style="display: none;">
            <div class="cache-icon"></div>
            <span>数据已缓存</span>
        </div>
        
        <div class="english-tooltip" id="englishTooltip"></div>
        <div class="syntax-tooltip" id="syntaxTooltip"></div>
        
        <header>
            <div class="header-content">
                <h1>千与千寻</h1>
                <div class="header-buttons">
                    <button class="file-upload-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        加载台词文件
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
                    
                    <button class="edit-columns-btn" id="editColumnsBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        编辑表格列
                    </button>
                    
                    <button class="playlist-btn" id="playlistBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        列表播放
                    </button>
                    
                    <button class="row-edit-btn" id="rowEditBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="9"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                            <line x1="9" y1="12" x2="15" y2="12"></line>
                        </svg>
                        行编辑
                    </button>
                </div>
            </div>
        </header>
        
        <div class="column-editor" id="columnEditor">
            <h3>选择要显示的列</h3>
            <div class="column-checkboxes">
                <div class="column-option">
                    <input type="checkbox" id="colIndex" checked data-column="1">
                    <label for="colIndex">序号</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="colTime" checked data-column="2">
                    <label for="colTime">时间</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="colCharacter" checked data-column="3">
                    <label for="colCharacter">人物</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="colEnglish" checked data-column="4">
                    <label for="colEnglish">英文台词</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="colChinese" checked data-column="5">
                    <label for="colChinese">中文台词</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="colAudio" data-column="6">
                    <label for="colAudio">台词音频</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="colCode" data-column="7">
                    <label for="colCode">编码</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="colList" data-column="8">
                    <label for="colList">列表</label>
                </div>
            </div>
        </div>
        
        <div class="row-editor" id="rowEditor">
            <h3>行编辑选项</h3>
            <div class="row-editor-buttons">
                <button class="analysis-btn" id="showAllRowsBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                    </svg>
                    显示所有行
                </button>
                <button class="analysis-btn" id="showAudioRowsBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    仅显示有音频的行
                </button>
                <button class="analysis-btn" id="hideSelectedRowsBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    隐藏选中行
                </button>
            </div>
        </div>
        
        <div class="table-container" id="tableContainer">
            <table id="dialogueTable">
                <thead>
                    <tr>
                        <th class="row-selector-header">选择</th>
                        <th>序号</th>
                        <th>时间</th>
                        <th>人物</th>
                        <th>英文台词</th>
                        <th>中文台词</th>
                        <th>台词音频</th>
                        <th>编码</th>
                        <th>列表</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 表格内容将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
        
        <div class="overlay" id="overlay">
            <div class="card" id="dialogueCard">
                <div class="card-header">
                    <h2 class="card-title">台词详情</h2>
                    <div class="analysis-buttons">
                        <button class="analysis-btn lexical-btn" id="loadLexicalBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                            加载词法文件
                        </button>
                        <button class="analysis-btn syntactic-btn" id="loadSyntacticBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            加载句法文件
                        </button>
                    </div>
                </div>
                <div class="card-content" id="cardContent">
                    <div class="card-sentences">
                        <div class="english-sentence">Mom, Dad, please wait for me!</div>
                        <div class="chinese-sentence">妈妈，爸爸，请等等我！</div>
                    </div>
                    
                    <div class="audio-section">
                        <button class="analysis-btn add-audio-btn-card" id="addAudioBtnCard">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14"></path>
                                <path d="M5 12h14"></path>
                            </svg>
                            添加音频文件
                        </button>
                    </div>
                    
                    <div class="analysis-section">
                        <div id="lexicalContent" class="analysis-content" style="display: none"></div>
                        <div id="syntacticContent" class="analysis-content" style="display: none"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 播放列表卡片 -->
        <div class="overlay" id="playlistOverlay">
            <div class="playlist-card" id="playlistCard">
                <div class="card-header">
                    <h2 class="card-title">播放列表</h2>
                </div>
                <div class="card-content">
                    <table class="playlist-table" id="playlistTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllPlaylist"></th>
                                <th>序号</th>
                                <th>英文台词</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="playlistTableBody">
                            <!-- 播放列表内容将在这里动态生成 -->
                        </tbody>
                    </table>
                    
                    <div class="playlist-controls">
                        <button class="playlist-btn-action play-btn" id="playSelectedBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            播放选中项
                        </button>
                        <button class="playlist-btn-action stop-btn" id="stopPlaybackBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                            停止播放
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 元素引用
            const fileInput = document.getElementById('fileInput');
            const fileUploadBtn = document.querySelector('.file-upload-btn');
            const editColumnsBtn = document.getElementById('editColumnsBtn');
            const playlistBtn = document.getElementById('playlistBtn');
            const rowEditBtn = document.getElementById('rowEditBtn');
            const columnEditor = document.getElementById('columnEditor');
            const rowEditor = document.getElementById('rowEditor');
            const table = document.getElementById('dialogueTable');
            const tableContainer = document.getElementById('tableContainer');
            const tableBody = table.querySelector('tbody');
            const overlay = document.getElementById('overlay');
            const playlistOverlay = document.getElementById('playlistOverlay');
            const cardContent = document.getElementById('cardContent');
            const columnCheckboxes = document.querySelectorAll('.column-checkboxes input[type="checkbox"]');
            const cacheIndicator = document.getElementById('cacheIndicator');
            const englishTooltip = document.getElementById('englishTooltip');
            const syntaxTooltip = document.getElementById('syntaxTooltip');
            const selectAllPlaylist = document.getElementById('selectAllPlaylist');
            
            // 表格数据存储 - 初始化为空数组
            let tableData = [];
            
            // 当前播放的音频
            let currentAudio = null;
            let currentPlaylist = [];
            let currentPlayIndex = -1;
            let playbackInterval = null;
            
            // 当前显示的卡片数据
            let currentCardData = null;
            let currentRowIndex = null;
            
            // 编码规则映射
            const codeRules = {
                "AAA": "陈述句",
                "AABA": "一般疑问句",
                "AABB": "特殊疑问句",
                "AABC": "选择疑问句",
                "AABD": "反意疑问句",
                "AAC": "祈使句",
                "AAD": "感叹句",
                "ABA": "简单句",
                "ABB": "并列复合句",
                "ABCAA": "主语从句",
                "ABCAB": "宾语从句",
                "ABCAC": "表语从句",
                "ABCAD": "同位语从句",
                "ABCAE": "直接引语",
                "ABCAF": "间接引语",
                "ABCBA": "限制性定语从句",
                "ABCBB": "非限制性定语从句",
                "ABCCA": "时间状语从句",
                "ABCCB": "地点状语从句",
                "ABCCC": "原因状语从句",
                "ABCCD": "目的状语从句",
                "ABCCE": "结果状语从句",
                "ABCCF": "条件状语从句",
                "ABCCG": "让步状语从句",
                "ABCCH": "比较状语从句",
                "ABCCI": "方式状语从句",
                "ACA": "主谓",
                "ACB": "主谓宾",
                "ACC": "主系表",
                "ACD": "主谓间宾直宾",
                "ACE": "主谓宾宾补",
                "ACF": "主谓状",
                "ACG": "主谓宾状语",
                "ACH": "存现句",
                "ADA": "一般现在时",
                "ADB": "一般过去时",
                "ADC": "一般将来时",
                "ADD": "一般过去将来时",
                "ADE": "现在进行时",
                "ADF": "过去进行时",
                "ADG": "将来进行时",
                "ADH": "过去将来进行时",
                "ADI": "现在完成时",
                "ADJ": "过去完成时",
                "ADK": "将来完成时",
                "ADL": "过去将来完成时",
                "ADM": "现在完成进行时",
                "ADN": "过去完成进行时",
                "ADO": "将来完成进行时",
                "ADP": "过去将来完成进行时",
                "AEA": "主语",
                "AEB": "谓语",
                "AEC": "表语",
                "AED": "宾语",
                "AEE": "定语",
                "AEF": "状语",
                "AEG": "补足语",
                "AEH": "同位语",
                "AEI": "独立成分"
            };
            
            // 从缓存加载数据
            loadFromCache();
            
            // 自动加载默认Excel文件
            loadDefaultExcel();
            
            // 文件上传按钮事件
            fileUploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件选择事件
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                processExcelFile(file);
            });
            
            // 编辑列按钮事件
            editColumnsBtn.addEventListener('click', function() {
                columnEditor.style.display = columnEditor.style.display === 'block' ? 'none' : 'block';
                rowEditor.style.display = 'none';
            });
            
            // 行编辑按钮事件
            rowEditBtn.addEventListener('click', function() {
                const isVisible = rowEditor.style.display === 'block';
                rowEditor.style.display = isVisible ? 'none' : 'block';
                columnEditor.style.display = 'none';
                
                // 切换行选择列的显示
                if (isVisible) {
                    tableContainer.classList.remove('row-editor-visible');
                } else {
                    tableContainer.classList.add('row-editor-visible');
                }
            });
            
            // 列表播放按钮事件
            playlistBtn.addEventListener('click', function() {
                showPlaylist();
            });
            
            // 列显示/隐藏事件
            columnCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const colIndex = parseInt(this.dataset.column);
                    const columns = table.querySelectorAll('tr > *:nth-child(' + (colIndex + 1) + ')');
                    
                    if (this.checked) {
                        columns.forEach(col => col.style.display = '');
                    } else {
                        columns.forEach(col => col.style.display = 'none');
                    }
                });
            });
            
            // 全选播放列表事件
            selectAllPlaylist.addEventListener('change', function() {
                const playlistSelectors = document.querySelectorAll('.playlist-selector');
                playlistSelectors.forEach(selector => {
                    selector.checked = this.checked;
                });
            });
            
            // 显示所有行按钮事件
            document.getElementById('showAllRowsBtn').addEventListener('click', function() {
                tableData.forEach(data => {
                    data.visible = true;
                });
                populateTable();
                saveToCache();
            });
            
            // 仅显示有音频的行按钮事件
            document.getElementById('showAudioRowsBtn').addEventListener('click', function() {
                tableData.forEach(data => {
                    data.visible = !!data.audioFile;
                });
                populateTable();
                saveToCache();
            });
            
            // 隐藏选中行按钮事件
            document.getElementById('hideSelectedRowsBtn').addEventListener('click', function() {
                const rowSelectors = document.querySelectorAll('.row-selector');
                rowSelectors.forEach((selector, index) => {
                    if (selector.checked && index < tableData.length) {
                        tableData[index].visible = false;
                    }
                });
                populateTable();
                saveToCache();
            });
            
            // 双击行事件
            tableBody.addEventListener('dblclick', function(e) {
                const row = e.target.closest('tr');
                if (!row) return;
                
                const rowIndex = Array.from(row.parentNode.children).indexOf(row) - 1;
                if (rowIndex >= 0 && rowIndex < tableData.length) {
                    currentRowIndex = rowIndex;
                    currentCardData = tableData[rowIndex];
                    showCard(currentCardData);
                }
            });
            
            // 关闭卡片事件
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeCardHandler();
                }
            });
            
            // 关闭播放列表事件
            playlistOverlay.addEventListener('click', function(e) {
                if (e.target === playlistOverlay) {
                    playlistOverlay.style.display = 'none';
                }
            });
            
            // 关闭卡片函数
            function closeCardHandler() {
                overlay.style.display = 'none';
            }
            
            // 自动加载默认Excel文件
            function loadDefaultExcel() {
                fetch('./excel/千与千寻.xlsx')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('文件加载失败: ' + response.statusText);
                        }
                        return response.arrayBuffer();
                    })
                    .then(data => {
                        const workbook = XLSX.read(new Uint8Array(data), {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // 处理数据（跳过标题行）
                        tableData = jsonData.slice(1).map(row => {
                            return {
                                index: row[0] || '',
                                time: row[1] || '',
                                character: row[2] || '',
                                english: row[3] || '',
                                chinese: row[4] || '',
                                audio: row[5] || '',
                                code: row[6] || '',
                                list: row[7] || '',
                                audioFile: null,
                                lexicalData: null,
                                syntacticData: null,
                                visible: true
                            };
                        });
                        
                        // 保存到缓存
                        saveToCache();
                        
                        // 填充表格
                        populateTable();
                        
                        // 显示缓存指示器
                        showCacheIndicator();
                    })
                    .catch(error => {
                        console.error('加载默认Excel文件失败:', error);
                        // 使用示例数据作为后备
                        useSampleData();
                    });
            }
            
            // 处理Excel文件
            function processExcelFile(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 获取第一个工作表
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // 将工作表转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // 处理数据（跳过标题行）
                    tableData = jsonData.slice(1).map(row => {
                        return {
                            index: row[0] || '',
                            time: row[1] || '',
                            character: row[2] || '',
                            english: row[3] || '',
                            chinese: row[4] || '',
                            audio: row[5] || '',
                            code: row[6] || '',
                            list: row[7] || '',
                            audioFile: null,
                            lexicalData: null,
                            syntacticData: null,
                            visible: true
                        };
                    });
                    
                    // 保存到缓存
                    saveToCache();
                    
                    // 填充表格
                    populateTable();
                    
                    // 显示缓存指示器
                    showCacheIndicator();
                };
                reader.readAsArrayBuffer(file);
            }
            
            // 使用示例数据
            function useSampleData() {
                tableData = [
                    {
                        index: "1",
                        time: "00:05:23",
                        character: "千寻",
                        english: "Mom, Dad, please wait for me!",
                        chinese: "妈妈，爸爸，请等等我！",
                        audio: "",
                        code: "AAD,ACC,ADA",
                        list: "",
                        audioFile: null,
                        visible: true
                    },
                    {
                        index: "2",
                        time: "00:12:45",
                        character: "白龙",
                        english: "You must remember your real name.",
                        chinese: "你必须记住你真正的名字。",
                        audio: "",
                        code: "AAA,ACB,ADB",
                        list: "",
                        audioFile: null,
                        visible: true
                    },
                    {
                        index: "3",
                        time: "00:25:18",
                        character: "锅炉爷爷",
                        english: "Work hard and never complain.",
                        chinese: "努力工作，永远不要抱怨。",
                        audio: "",
                        code: "AAC,ABB,ADA",
                        list: "",
                        audioFile: null,
                        visible: true
                    }
                ];
                
                // 保存到缓存
                saveToCache();
                
                // 填充表格
                populateTable();
                
                // 显示缓存指示器
                showCacheIndicator();
            }
            
            // 填充表格函数
            function populateTable() {
                tableBody.innerHTML = '';
                
                tableData.forEach((data, index) => {
                    if (!data.visible) return;
                    
                    const row = document.createElement('tr');
                    
                    // 音频单元格处理
                    let audioCellContent = '';
                    if (data.audioFile) {
                        audioCellContent = `
                            <div class="audio-cell">
                                <div class="audio-controls">
                                    <span class="audio-icon"></span>
                                    <span>播放音频</span>
                                </div>
                                <button class="add-audio-btn">+</button>
                                <input type="file" class="audio-upload" accept="audio/*">
                            </div>
                        `;
                    } else {
                        audioCellContent = `
                            <div class="audio-cell">
                                <span class="audio-placeholder">双击添加音频</span>
                                <button class="add-audio-btn">+</button>
                                <input type="file" class="audio-upload" accept="audio/*">
                            </div>
                        `;
                    }
                    
                    row.innerHTML = `
                        <td class="row-selector-cell"><input type="checkbox" class="row-selector"></td>
                        <td>${data.index}</td>
                        <td>${data.time}</td>
                        <td>${data.character}</td>
                        <td>${data.english}</td>
                        <td>${data.chinese}</td>
                        <td>${audioCellContent}</td>
                        <td>${data.code}</td>
                        <td>${data.list}</td>
                    `;
                    
                    // 添加悬停效果
                    row.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f0f7ff';
                    });
                    
                    row.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    tableBody.appendChild(row);
                    
                    // 获取新添加行的音频单元格
                    const audioCell = row.querySelector('.audio-cell');
                    const audioUpload = row.querySelector('.audio-upload');
                    const addAudioBtn = row.querySelector('.add-audio-btn');
                    
                    // 添加音频单元格双击事件
                    audioCell.addEventListener('dblclick', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        audioUpload.click(); // 触发文件选择
                    });
                    
                    // 添加音频按钮点击事件
                    addAudioBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        audioUpload.click(); // 触发文件选择
                    });
                    
                    // 添加音频单元格单击事件
                    audioCell.addEventListener('click', function(e) {
                        // 防止点击添加按钮时触发播放
                        if (e.target !== addAudioBtn && e.target !== audioUpload) {
                            // 如果已经有音频文件，则播放
                            if (data.audioFile) {
                                playAudio(data.audioFile);
                            }
                        }
                    });
                    
                    // 添加音频文件选择事件
                    audioUpload.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // 检查文件类型
                        if (!file.type.startsWith('audio/')) {
                            alert('请选择音频文件 (MP3, WAV, OGG等)');
                            return;
                        }
                        
                        // 更新数据
                        data.audioFile = URL.createObjectURL(file);
                        data.audio = file.name;
                        
                        // 更新表格行
                        if (index < tableData.length) {
                            updateTableRow(index, data);
                        }
                        
                        // 保存到缓存
                        saveToCache();
                    });
                    
                    // 为英文台词单元格添加提示框功能
                    const englishCell = row.querySelector('td:nth-child(5)');
                    setupEnglishTooltip(englishCell, data);
                });
                
                // 默认隐藏某些列
                hideColumnsByDefault();
            }
            
            // 默认隐藏某些列
            function hideColumnsByDefault() {
                // 隐藏音频列、编码列和列表列
                const columnsToHide = [6, 7, 8];
                
                columnsToHide.forEach(colIndex => {
                    const columns = table.querySelectorAll(`tr > *:nth-child(${colIndex + 1})`);
                    columns.forEach(col => col.style.display = 'none');
                });
                
                // 更新复选框状态
                document.getElementById('colAudio').checked = false;
                document.getElementById('colCode').checked = false;
                document.getElementById('colList').checked = false;
            }
            
            // 设置英文台词提示框功能
            function setupEnglishTooltip(cell, rowData) {
                // 鼠标移入事件
                cell.addEventListener('mouseenter', function(e) {
                    const text = this.textContent;
                    if (!text) return;
                    
                    // 更新英文台词提示框内容和位置
                    englishTooltip.textContent = text;
                    englishTooltip.style.left = e.pageX + 'px';
                    englishTooltip.style.top = (e.pageY - 50) + 'px';
                    englishTooltip.classList.add('visible');
                    
                    // 显示语法分析提示框
                    showSyntaxTooltip(e, rowData);
                });
                
                // 鼠标移动事件 - 更新提示框位置
                cell.addEventListener('mousemove', function(e) {
                    englishTooltip.style.left = e.pageX + 'px';
                    englishTooltip.style.top = (e.pageY - 50) + 'px';
                    updateSyntaxTooltipPosition(e);
                });
                
                // 鼠标移出事件
                cell.addEventListener('mouseleave', function() {
                    englishTooltip.classList.remove('visible');
                    syntaxTooltip.classList.remove('visible');
                });
            }
            
            // 显示语法分析提示框
            function showSyntaxTooltip(e, rowData) {
                if (!rowData.code) {
                    syntaxTooltip.innerHTML = `
                        <div class="syntax-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            语法分析
                        </div>
                        <div class="syntax-content">
                            该台词暂无语法分析数据
                        </div>
                    `;
                } else {
                    // 解析编码
                    const syntaxInfo = parseCode(rowData.code);
                    
                    // 构建提示框内容
                    let contentHTML = '';
                    
                    if (syntaxInfo.sentenceType) {
                        contentHTML += `
                            <div class="syntax-item">
                                <div class="syntax-label">句型:</div>
                                <div class="syntax-value">${syntaxInfo.sentenceType}</div>
                            </div>
                        `;
                    }
                    
                    if (syntaxInfo.sentenceStructure) {
                        contentHTML += `
                            <div class="syntax-item">
                                <div class="syntax-label">结构:</div>
                                <div class="syntax-value">${syntaxInfo.sentenceStructure}</div>
                            </div>
                        `;
                    }
                    
                    if (syntaxInfo.tense) {
                        contentHTML += `
                            <div class="syntax-item">
                                <div class="syntax-label">时态:</div>
                                <div class="syntax-value">${syntaxInfo.tense}</div>
                            </div>
                        `;
                    }
                    
                    if (syntaxInfo.components && syntaxInfo.components.length > 0) {
                        contentHTML += `
                            <div class="syntax-item">
                                <div class="syntax-label">句子成分:</div>
                                <div class="syntax-value">${syntaxInfo.components.join('、')}</div>
                            </div>
                        `;
                    }
                    
                    syntaxTooltip.innerHTML = `
                        <div class="syntax-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            语法分析
                        </div>
                        <div class="syntax-content">
                            ${contentHTML || '<div class="syntax-item">无法解析语法编码</div>'}
                        </div>
                    `;
                }
                
                syntaxTooltip.style.left = (e.pageX + 20) + 'px';
                syntaxTooltip.style.top = (e.pageY - 150) + 'px';
                syntaxTooltip.classList.add('visible');
            }
            
            // 更新语法提示框位置
            function updateSyntaxTooltipPosition(e) {
                syntaxTooltip.style.left = (e.pageX + 20) + 'px';
                syntaxTooltip.style.top = (e.pageY - 150) + 'px';
            }
            
            // 解析编码为语法信息
            function parseCode(code) {
                const result = {
                    sentenceType: null,
                    sentenceStructure: null,
                    tense: null,
                    components: []
                };
                
                if (!code) return result;
                
                // 分割编码
                const codes = code.split(',').map(c => c.trim());
                
                codes.forEach(c => {
                    if (c.startsWith('AA')) {
                        // 句型
                        result.sentenceType = codeRules[c] || c;
                    } else if (c.startsWith('AC')) {
                        // 结构
                        result.sentenceStructure = codeRules[c] || c;
                    } else if (c.startsWith('AD')) {
                        // 时态
                        result.tense = codeRules[c] || c;
                    } else if (c.startsWith('AE')) {
                        // 成分
                        const component = codeRules[c] || c;
                        if (component) {
                            result.components.push(component);
                        }
                    }
                });
                
                return result;
            }
            
            // 更新表格行函数
            function updateTableRow(rowIndex, data) {
                const rows = tableBody.querySelectorAll('tr');
                if (rowIndex < 0 || rowIndex >= rows.length) return;
                
                const row = rows[rowIndex];
                const audioCell = row.querySelector('.audio-cell');
                
                // 更新音频单元格
                if (data.audioFile) {
                    audioCell.innerHTML = `
                        <div class="audio-controls">
                            <span class="audio-icon"></span>
                            <span>播放音频</span>
                        </div>
                        <button class="add-audio-btn">+</button>
                        <input type="file" class="audio-upload" accept="audio/*">
                    `;
                } else {
                    audioCell.innerHTML = `
                        <span class="audio-placeholder">双击添加音频</span>
                        <button class="add-audio-btn">+</button>
                        <input type="file" class="audio-upload" accept="audio/*">
                    `;
                }
                
                // 重新绑定事件
                const audioUpload = audioCell.querySelector('.audio-upload');
                const addAudioBtn = audioCell.querySelector('.add-audio-btn');
                
                audioCell.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    audioUpload.click();
                });
                
                addAudioBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    audioUpload.click();
                });
                
                audioCell.addEventListener('click', function(e) {
                    if (e.target !== addAudioBtn && e.target !== audioUpload) {
                        if (data.audioFile) {
                            playAudio(data.audioFile);
                        }
                    }
                });
                
                audioUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('audio/')) {
                        alert('请选择音频文件 (MP3, WAV, OGG等)');
                        return;
                    }
                    
                    // 更新数据
                    data.audioFile = URL.createObjectURL(file);
                    data.audio = file.name;
                    
                    // 更新单元格显示
                    audioCell.innerHTML = `
                        <div class="audio-controls">
                            <span class="audio-icon"></span>
                            <span>播放音频</span>
                        </div>
                        <button class="add-audio-btn">+</button>
                        <input type="file" class="audio-upload" accept="audio/*">
                    `;
                    
                    // 重新绑定事件
                    const newAddAudioBtn = audioCell.querySelector('.add-audio-btn');
                    const newAudioUpload = audioCell.querySelector('.audio-upload');
                    
                    newAddAudioBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        newAudioUpload.click();
                    });
                    
                    audioCell.addEventListener('dblclick', function(e) {
                        e.stopPropagation();
                        newAudioUpload.click();
                    });
                    
                    audioCell.addEventListener('click', function(e) {
                        if (e.target !== newAddAudioBtn && e.target !== newAudioUpload) {
                            playAudio(data.audioFile);
                        }
                    });
                    
                    // 保存到缓存
                    saveToCache();
                });
                
                // 重新绑定英文台词提示框
                const englishCell = row.querySelector('td:nth-child(5)');
                setupEnglishTooltip(englishCell, data);
            }
            
            // 播放音频函数
            function playAudio(audioUrl) {
                // 停止当前正在播放的音频
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                // 创建新的音频对象并播放
                currentAudio = new Audio(audioUrl);
                currentAudio.play().catch(e => {
                    console.error('播放音频失败:', e);
                });
            }
            
            // 显示卡片函数
            function showCard(data) {
                let audioContent = '';
                if (data.audioFile) {
                    // 已加载音频 - 显示播放器
                    audioContent = `
                        <audio controls class="audio-player">
                            <source src="${data.audioFile}" type="audio/mpeg">
                            您的浏览器不支持音频元素
                        </audio>
                    `;
                } else {
                    // 未加载音频 - 显示添加按钮
                    audioContent = `
                        <button class="analysis-btn add-audio-btn-card" id="addAudioBtnCard">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14"></path>
                                <path d="M5 12h14"></path>
                            </svg>
                            添加音频文件
                        </button>
                        <input type="file" id="audioUploadCard" class="audio-upload" accept="audio/*" style="display:none">
                    `;
                }
                
                // 解析语法编码
                const syntaxInfo = parseCode(data.code);
                let syntaxContent = '';
                
                if (syntaxInfo.sentenceType || syntaxInfo.sentenceStructure || 
                    syntaxInfo.tense || syntaxInfo.components.length > 0) {
                    
                    syntaxContent = `
                        <div class="analysis-section">
                            <h3>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                语法分析
                            </h3>
                            <div class="analysis-content">
                                <table class="analysis-table">
                                    <tbody>
                                        ${syntaxInfo.sentenceType ? `
                                            <tr>
                                                <th>句型</th>
                                                <td>${syntaxInfo.sentenceType}</td>
                                            </tr>
                                        ` : ''}
                                        ${syntaxInfo.sentenceStructure ? `
                                            <tr>
                                                <th>结构</th>
                                                <td>${syntaxInfo.sentenceStructure}</td>
                                            </tr>
                                        ` : ''}
                                        ${syntaxInfo.tense ? `
                                            <tr>
                                                <th>时态</th>
                                                <td>${syntaxInfo.tense}</td>
                                            </tr>
                                        ` : ''}
                                        ${syntaxInfo.components.length > 0 ? `
                                            <tr>
                                                <th>句子成分</th>
                                                <td>${syntaxInfo.components.join('、')}</td>
                                            </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                cardContent.innerHTML = `
                    <div class="card-sentences">
                        <div class="english-sentence">${data.english}</div>
                        <div class="chinese-sentence">${data.chinese}</div>
                    </div>
                    
                    <div class="audio-section">
                        ${audioContent}
                    </div>
                    
                    ${syntaxContent}
                    
                    <div class="analysis-section">
                        <div id="lexicalContent" class="analysis-content" style="${data.lexicalData ? '' : 'display: none'}">
                            ${data.lexicalData ? formatAnalysisData(data.lexicalData) : ''}
                        </div>
                        
                        <div id="syntacticContent" class="analysis-content" style="${data.syntacticData ? '' : 'display: none'}">
                            ${data.syntacticData ? formatAnalysisData(data.syntacticData) : ''}
                        </div>
                    </div>
                `;
                
                // 绑定卡片中添加音频按钮事件
                const addAudioBtnCard = document.getElementById('addAudioBtnCard');
                const audioUploadCard = document.getElementById('audioUploadCard');
                
                if (addAudioBtnCard && audioUploadCard) {
                    addAudioBtnCard.addEventListener('click', function() {
                        audioUploadCard.click();
                    });
                    
                    audioUploadCard.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        if (!file.type.startsWith('audio/')) {
                            alert('请选择音频文件 (MP3, WAV, OGG等)');
                            return;
                        }
                        
                        // 更新当前数据
                        data.audioFile = URL.createObjectURL(file);
                        data.audio = file.name;
                        
                        // 更新表格行
                        if (currentRowIndex !== null) {
                            updateTableRow(currentRowIndex, data);
                        }
                        
                        // 保存到缓存
                        saveToCache();
                        
                        // 重新渲染卡片
                        showCard(data);
                    });
                }
                
                // 绑定词法文件按钮事件
                document.getElementById('loadLexicalBtn').addEventListener('click', function() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.xlsx, .xls';
                    input.onchange = e => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                    reader.onload = function(e) {
                        const dataArray = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(dataArray, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // 存储词法数据
                        data.lexicalData = jsonData;
                        
                        // 更新卡片显示
                        document.getElementById('lexicalContent').innerHTML = formatAnalysisData(jsonData);
                        document.getElementById('lexicalContent').style.display = 'block';
                        
                        // 保存到缓存
                        saveToCache();
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            });
            
            // 绑定句法文件按钮事件
            document.getElementById('loadSyntacticBtn').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const dataArray = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(dataArray, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // 存储句法数据
                        data.syntacticData = jsonData;
                        
                        // 更新卡片显示
                        document.getElementById('syntacticContent').innerHTML = formatAnalysisData(jsonData);
                        document.getElementById('syntacticContent').style.display = 'block';
                        
                        // 保存到缓存
                        saveToCache();
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            });
            
            overlay.style.display = 'flex';
        }
        
        // 显示播放列表函数
        function showPlaylist() {
            const playlistTableBody = document.getElementById('playlistTableBody');
            playlistTableBody.innerHTML = '';
            
            // 过滤出有音频的行
            const audioRows = tableData.filter(row => row.audioFile);
            
            if (audioRows.length === 0) {
                playlistTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px;">
                            没有可播放的音频文件。请为台词添加音频。
                        </td>
                    </tr>
                `;
                playlistOverlay.style.display = 'flex';
                return;
            }
            
            // 填充播放列表
            audioRows.forEach((data, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                
                row.innerHTML = `
                    <td><input type="checkbox" class="playlist-selector" checked></td>
                    <td>${data.index}</td>
                    <td>${data.english}</td>
                    <td>
                        <button class="play-btn play-single-btn" data-index="${index}">
                            <span class="playlist-audio-icon"></span>
                            播放
                        </button>
                    </td>
                `;
                
                playlistTableBody.appendChild(row);
                
                // 绑定单个播放按钮事件
                const playSingleBtn = row.querySelector('.play-single-btn');
                playSingleBtn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    playSingleAudio(index);
                });
            });
            
            // 重置全选状态
            selectAllPlaylist.checked = true;
            
            // 显示播放列表
            playlistOverlay.style.display = 'flex';
            
            // 绑定播放选中项按钮事件
            document.getElementById('playSelectedBtn').addEventListener('click', playSelectedAudios);
            
            // 绑定停止播放按钮事件
            document.getElementById('stopPlaybackBtn').addEventListener('click', stopPlayback);
        }
        
        // 播放单个音频
        function playSingleAudio(index) {
            if (index < 0 || index >= tableData.length || !tableData[index].audioFile) return;
            
            // 停止当前播放
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            
            // 播放选中的音频
            currentAudio = new Audio(tableData[index].audioFile);
            currentAudio.play().catch(e => {
                console.error('播放音频失败:', e);
            });
        }
        
        // 播放选中的音频
        function playSelectedAudios() {
            const playlistRows = document.querySelectorAll('#playlistTableBody tr');
            currentPlaylist = [];
            
            // 收集选中的行
            playlistRows.forEach((row, index) => {
                const selector = row.querySelector('.playlist-selector');
                if (selector && selector.checked) {
                    currentPlaylist.push(index);
                }
            });
            
            if (currentPlaylist.length === 0) {
                alert('请至少选择一项进行播放');
                return;
            }
            
            // 重置播放状态
            currentPlayIndex = -1;
            
            // 移除所有高亮样式
            playlistRows.forEach(row => {
                row.classList.remove('playing-row');
            });
            
            // 开始播放
            playNextInPlaylist();
        }
        
        // 播放播放列表中的下一个音频
        function playNextInPlaylist() {
            if (currentPlayIndex >= 0) {
                // 移除上一个播放项的高亮
                const prevRow = document.querySelector(`#playlistTableBody tr:nth-child(${currentPlayIndex + 1})`);
                if (prevRow) {
                    prevRow.classList.remove('playing-row');
                }
            }
            
            currentPlayIndex++;
            
            if (currentPlayIndex >= currentPlaylist.length) {
                // 播放结束
                return;
            }
            
            const playlistRows = document.querySelectorAll('#playlistTableBody tr');
            const currentIndex = currentPlaylist[currentPlayIndex];
            
            // 高亮当前播放行
            if (currentIndex < playlistRows.length) {
                playlistRows[currentIndex].classList.add('playing-row');
            }
            
            // 播放音频
            const audioData = tableData.find(row => row.index == playlistRows[currentIndex].cells[1].textContent);
            if (audioData && audioData.audioFile) {
                // 停止当前播放
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                // 播放新音频
                currentAudio = new Audio(audioData.audioFile);
                currentAudio.play().catch(e => {
                    console.error('播放音频失败:', e);
                });
                
                // 监听音频结束事件，播放下一个
                currentAudio.onended = function() {
                    playNextInPlaylist();
                };
            } else {
                // 如果没有音频文件，直接播放下一个
                playNextInPlaylist();
            }
        }
        
        // 停止播放
        function stopPlayback() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            
            // 移除所有高亮样式
            const playlistRows = document.querySelectorAll('#playlistTableBody tr');
            playlistRows.forEach(row => {
                row.classList.remove('playing-row');
            });
            
            currentPlayIndex = -1;
        }
        
        // 格式化分析数据为表格
        function formatAnalysisData(data) {
            if (!data || data.length === 0) return '<p>无分析数据</p>';
            
            let headers = data[0];
            let rows = data.slice(1);
            
            let tableHTML = '<table class="analysis-table">';
            
            // 表头
            tableHTML += '<tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr>';
            
            // 数据行
            rows.forEach(row => {
                tableHTML += '<tr>';
                row.forEach(cell => {
                    tableHTML += `<td>${cell}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</table>';
            return tableHTML;
        }
        
        // 列宽调整功能
        const thElements = table.querySelectorAll('th');
        let startX, startWidth, currentTh;
        
        thElements.forEach(th => {
            const resizer = document.createElement('div');
            resizer.className = 'resizer';
            
            th.appendChild(resizer);
            
            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                startX = e.clientX;
                startWidth = th.offsetWidth;
                currentTh = th;
                resizer.classList.add('resizing');
                
                document.addEventListener('mousemove', resizeHandler);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resizeHandler(e) {
                if (!currentTh) return;
                
                const newWidth = startWidth + (e.clientX - startX);
                currentTh.style.width = `${newWidth}px`;
                
                // 更新整个表格布局
                table.style.width = 'auto';
            }
            
            function stopResize() {
                if (resizer) {
                    resizer.classList.remove('resizing');
                }
                currentTh = null;
                document.removeEventListener('mousemove', resizeHandler);
                document.removeEventListener('mouseup', stopResize);
            }
        });
        
        // 保存数据到缓存
        function saveToCache() {
            try {
                // 准备要缓存的数据
                const dataToCache = {
                    tableData: tableData.map(item => {
                        // 不缓存音频文件对象（因为无法序列化）
                        return {
                            ...item,
                            audioFile: null,
                            lexicalData: item.lexicalData || null,
                            syntacticData: item.syntacticData || null
                        };
                    })
                };
                
                // 保存到localStorage
                localStorage.setItem('spiritedAwayData', JSON.stringify(dataToCache));
                console.log('数据已保存到缓存');
            } catch (e) {
                console.error('保存到缓存失败:', e);
            }
        }
        
        // 从缓存加载数据
        function loadFromCache() {
            try {
                const cachedData = localStorage.getItem('spiritedAwayData');
                if (cachedData) {
                    const parsedData = JSON.parse(cachedData);
                    tableData = parsedData.tableData || [];
                    
                    // 恢复音频文件对象（如果存在）
                    tableData.forEach(item => {
                        if (item.audio) {
                            // 这里无法恢复原始音频文件，但可以显示文件名
                            // 实际播放需要重新上传
                        }
                    });
                    
                    console.log('从缓存加载数据成功');
                }
            } catch (e) {
                console.error('从缓存加载数据失败:', e);
            }
        }
        
        // 显示缓存指示器
        function showCacheIndicator() {
            cacheIndicator.style.display = 'flex';
            setTimeout(() => {
                cacheIndicator.style.opacity = '0';
                setTimeout(() => {
                    cacheIndicator.style.display = 'none';
                    cacheIndicator.style.opacity = '1';
                }, 1000);
            }, 3000);
        }
    });
    </script>
</body>
</html>